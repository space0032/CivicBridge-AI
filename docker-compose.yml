version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgis/postgis:15-3.3
    container_name: civicbridge-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - civicbridge-network

  # MongoDB Database
  mongodb:
    image: mongo:7
    container_name: civicbridge-mongodb
    environment:
      MONGO_INITDB_DATABASE: civicbridge
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
    networks:
      - civicbridge-network

  # Mongo Express - Web UI for MongoDB
  mongo-express:
    image: mongo-express:latest
    container_name: civicbridge-mongo-express
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongodb
      - ME_CONFIG_MONGODB_PORT=27017
      - ME_CONFIG_MONGODB_ENABLE_ADMIN=true
      - ME_CONFIG_MONGODB_AUTH_DATABASE=civicbridge
      - ME_CONFIG_BASICAUTH_USERNAME=admin
      - ME_CONFIG_BASICAUTH_PASSWORD=pass
    ports:
      - "8081:8081"
    depends_on:
      - mongodb
    networks:
      - civicbridge-network

  # pgAdmin - Web UI for PostgreSQL
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: civicbridge-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@civicbridge.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - civicbridge-network

  # Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: civicbridge-backend
    env_file:
      - .env
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/civicbridge
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
      - SPRING_DATA_MONGODB_URI=mongodb://mongodb:27017/civicbridge
      - AI_PROVIDER=${AI_PROVIDER}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - mongodb
    networks:
      - civicbridge-network

  # Frontend Web Service
  frontend-web:
    build:
      context: ./frontend-web
      dockerfile: Dockerfile
    container_name: civicbridge-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - civicbridge-network

networks:
  civicbridge-network:
    driver: bridge

volumes:
  postgres-data:
  mongodb-data:
